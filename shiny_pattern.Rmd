---
title: "Shiny_pattrern"
author: "Deepan"
date: "9/7/2025"
output: html_document
---

## Load required libraries. If you don't have them, install with install.packages("package_name"). Might need to restart your R session after installing shiny. 

```{r}
library(shiny)
library(png)
library(jpeg)
library(stringr)

```


## 2D image interpolater funtcion. Needs to be run only once per session (DO NOT EDIT)

```{r}

# 2D bilinear interpolation resize
resize_bilinear <- function(img, new_width, new_height) {
  old_height <- nrow(img)
  old_width  <- ncol(img)
  
  # New coordinate grid
  x_new <- seq(1, old_width, length.out = new_width)
  y_new <- seq(1, old_height, length.out = new_height)
  
  # Output matrix
  out <- matrix(0, nrow = new_height, ncol = new_width)
  
  for (i in seq_along(y_new)) {
    for (j in seq_along(x_new)) {
      # Coordinates in original image
      x <- x_new[j]
      y <- y_new[i]
      
      # Nearest 4 neighbors
      x1 <- floor(x); x2 <- min(x1 + 1, old_width)
      y1 <- floor(y); y2 <- min(y1 + 1, old_height)
      
      # Distances
      dx <- x - x1
      dy <- y - y1
      
      # Pixel values (grayscale intensities)
      Q11 <- img[y1, x1]
      Q21 <- img[y1, x2]
      Q12 <- img[y2, x1]
      Q22 <- img[y2, x2]
      
      # Bilinear interpolation formula
      out[i, j] <- (Q11 * (1 - dx) * (1 - dy) +
                    Q21 * dx * (1 - dy) +
                    Q12 * (1 - dx) * dy +
                    Q22 * dx * dy)
    }
  }
  
  return(out)
}

```


```{r}


## defining the user interface

ui <- fluidPage(
  titlePanel("Outline to Dot Diagram"),
  sidebarLayout(
    sidebarPanel(
      fileInput("pattern_image", "Upload a square Image", accept = c("image/png", "image/jpeg")),
      fileInput("target_file", "Upload the target based field file", accept = c("target_file/fld")),
      textInput("bacteria_well", "Enter the well ID in the probe plate that contains your bacteria (format: ColumnRow, eg: first well would be A1, A2, A3....A12, B1"),
      #sliderInput("erode", "Make the outline of your logo thicker to improve resolution", min = 0, max = 6, value = 0, step = 0.01),
      sliderInput("thresh", "Grayscale Threshold", min = 0, max = 1, value = 0.5, step = 0.01),
      downloadButton("field_file_download", "Download Field File")
    ),
    mainPanel(
      plotOutput("dotPlot"),
      tableOutput("field_file")
    )
  )
)

## defining the server

server <- function(input, output, session) {
  
  # Step 1: Load image & convert to binary mask
  outline_grid <- reactive({
    req(input$pattern_image)
    req(input$target_file)
    req(input$bacteria_well)
    ext <- tools::file_ext(input$pattern_image$name)
    
    if (tolower(ext) == "png") {
      img <- png::readPNG(input$pattern_image$datapath, info = TRUE)
      
      # check if image is square. 
      if(dim(img)[1] != dim(img)[2]){
        stop("Image needs to be sqaure. Resize to square and try again.")
      }
      
      if (length(dim(img)) == 3 && dim(img)[3] == 4) {
        # Use alpha channel if available
        mask <- ifelse(img[,,4] > 0.5, 1, 0)
      } else {
        # Fallback: grayscale if no alpha
        gray <- 0.2989*img[,,1] + 0.5870*img[,,2] + 0.1140*img[,,3] #standard luminence conversion from color to grayscale
        mask <- ifelse(gray < input$thresh, 1, 0)
        #mask <- image::ero
      }
    } else if (tolower(ext) %in% c("jpg", "jpeg")) {
      img <- jpeg::readJPEG(input$pattern_image$datapath)
      
      #check if image is square. 
      if(dim(img)[1] != dim(img)[2]){
        stop("Image needs to be sqaure. Resize to square and try again.")
      }
      
      gray <- 0.2989*img[,,1] + 0.5870*img[,,2] + 0.1140*img[,,3] #standard luminence conversion from color to grayscale
      mask <- ifelse(gray < input$thresh, 1, 0)
    } else {
      stop("Unsupported file format")
    }
    
    # Resize to target file coordinates. This is defined by the target file first downloaded, but for petri, has to be a square. Maximum x and y coordinates is 72x72 for a "petri" target with one field. 
    
    size_x <- as.numeric(str_split(readLines(input$target_file$datapath)[11], "= ", simplify = TRUE)[, 2])
    size_y <- as.numeric(str_split(readLines(input$target_file$datapath)[12], "= ", simplify = TRUE)[, 2])
    
    if (size_x != size_y) {
      stop("Target needs to be \"Petri\" for pattern printing. Upload a \"Petri\" target file from the printer.")
    }
    
    mask_resized <- resize_bilinear(mask, size_x, size_y)
    
    # Threshold back to binary
    mat_bin <- ifelse(mask_resized > 0.5, 1, 0)
    mat_bin
  })
  
  # Step 2: Convert matrix to coordinates
  field_file <- reactive({
    size_x <- as.numeric(str_split(readLines(input$target_file$datapath)[11], "= ", simplify = TRUE)[, 2])
    size_y <- as.numeric(str_split(readLines(input$target_file$datapath)[12], "= ", simplify = TRUE)[, 2])
    mat_bin <- outline_grid()
    pts <- which(mat_bin == 1, arr.ind = TRUE)
    data.frame(
      x = pts[,2],
      y = size_y - pts[,1] + 1
    )
  })
  
  # Step 3: Render dot diagram
  output$dotPlot <- renderPlot({
    size_x <- as.numeric(str_split(readLines(input$target_file$datapath)[11], "= ", simplify = TRUE)[, 2])
    size_y <- as.numeric(str_split(readLines(input$target_file$datapath)[12], "= ", simplify = TRUE)[, 2])
    mat_bin <- outline_grid()
    image(t(apply(mat_bin, 2, rev)), col=c("white","black"),
          axes=FALSE, asp=1)
    grid(nx = size_x, ny = size_y, col="gray", lty="dotted")
    box()
  })
  
  # Step 4: Show coordinates
  output$field_file <- renderTable({
    field_file()
  })
  
  # Step 5: Download coordinates
 # In server.R (inside shinyServer function)

  output$field_file_download <-
    downloadHandler(
    
    filename = function() {
      paste0("outline_field_file.fld")
    },
  content = function(file) {
    mat_bin <- outline_grid()
    # ---- Step 1: Read header lines (first 25 rows) ----
    
    header_lines <- readLines(input$target_file$datapath , n = 24)
    
    # ---- Step 2: Build coordinates section ----
    
    size_x <- as.numeric(str_split(readLines(input$target_file$datapath)[11], "= ", simplify = TRUE)[, 2])
    size_y <- as.numeric(str_split(readLines(input$target_file$datapath)[12], "= ", simplify = TRUE)[, 2])
    coord_lines <- c()
    for (i in 1:size_x) {
      for (j in 1:size_y) {
        coord <- paste0(i, "/", j)
        if (mat_bin[size_y - (i-1), j] == 1) {
          line <- paste(coord, paste("1", input$bacteria_well, sep = ""), "1,", sep = "\t")
        } else {
          line <- paste(coord, "", "", sep = "\t")
        }
        coord_lines <- c(coord_lines, line)
      }
    }
    
    # ---- Step 3: Add blank line + signature ----
    blank_line <- ""
    signature <- "ยง19-24-50-71-26-42-28-76-55-35-54-34-42-56-54-65-20-68-46-23-41-37-72-74-72-59-47-62-70-42-26-76-61-37-21-20-78-69-38-46-55-23-51-53" #standard signature junk line, necessary for the robot. Do not modifiy or remove this. 
    
    # ---- Step 4: Write out ----
    writeLines(c(header_lines, coord_lines, blank_line, signature), con = file, sep = "\n")
  }
    
)


}

```

## Run the app (open the app in your default browser if it doesn't automatically do so)

```{r}

shinyApp(ui, server)

```

